const translations = {
    en: {
      nav_features: "Features",
      nav_faq: "FAQ",
      nav_download: "Download",
      nav_about: "About",
      nav_menu: "Menu",
      hero_heading: "Gwenchana",
      hero_tagline: "Not just another Korean learning app",
      hero_support: "AI tutor makes understanding easier and keeps you motivated to practice every day",
      btn_appstore_pretitle: "Download on the",
      btn_appstore: "App Store",
      btn_googleplay_pretitle: "Get it on",
      btn_googleplay: "Google Play",
      features_title: "Why Gwenchana?",
      features_multi_title: "Multi-language Support",
      features_multi_desc: "Supports multiple languages with full localization.",
      features_auth_title: "Secure Authentication",
      features_auth_desc: "Log in with email, Google, or Facebook in seconds.",
      features_vocab_title: "Vocabulary Workouts",
      features_vocab_desc: "Interactive drills and flashcards keep new words fresh.",
      features_progress_title: "Progress Tracking",
      features_progress_desc: "Visualize your gains across every KIIP level.",
      features_ai_title: "AI Tutor",
      features_ai_desc: "Personalized explanations from an always-on AI coach.",
      features_offline_title: "Create Your Own Cards",
      features_offline_desc: "Add words, translations, and examples to study your way.",
      vocab_pill: "Interactive preview",
      vocab_title: "Build your vocabulary",
      vocab_body: "Tap a Korean word to reveal the translation in your language. Track your progress and enjoy learning with interactive flashcards.",
      vocab_hint_show: "Tap to reveal translation",
      vocab_hint_hide: "Tap to hide translation",
      vocab_prev: "Previous word",
      vocab_next: "Next word",
      faq_title: "FAQ",
      faq_q1: "Is Gwenchana good for beginners?",
      faq_a1: "Yes, you can start with simple words and guided practice.",
      download_title: "Download Gwenchana",
      download_subtitle: "Start your free trial today.",
      
    },
    ru: {
      nav_features: "Возможности",
      nav_faq: "Вопросы",
      nav_download: "Скачать",
      nav_about: "О нас",
      nav_menu: "Меню",
      hero_heading: "Gwenchana",
      hero_tagline: "Не просто очередное приложение для изучения корейского",
      hero_support: "ИИ-репетитор помогает быстрее понимать и мотивирует практиковаться каждый день",
      btn_appstore_pretitle: "Скачать в",
      btn_appstore: "App Store",
      btn_googleplay_pretitle: "Доступно в",
      btn_googleplay: "Google Play",
      features_title: "Почему Gwenchana?",
      features_multi_title: "Поддержка нескольких языков",
      features_multi_desc: "Локализация интерфейса на нескольких языках.",
      features_auth_title: "Безопасная авторизация",
      features_auth_desc: "Вход по email, Google или Facebook за секунды.",
      features_vocab_title: "Тренировки словаря",
      features_vocab_desc: "Интерактивные упражнения и карточки закрепляют новые слова.",
      features_progress_title: "Отслеживание прогресса",
      features_progress_desc: "Наглядно видите рост на каждом уровне KIIP.",
      features_ai_title: "AI-репетитор",
      features_ai_desc: "Персональные объяснения от наставника на базе ИИ 24/7.",
      features_offline_title: "Создавайте свои карточки",
      features_offline_desc: "Добавляйте слова, переводы и примеры под ваш стиль обучения.",
      vocab_pill: "Интерактивный превью",
      vocab_title: "Прокачайте словарный запас",
      vocab_body: "Нажмите на корейское слово, чтобы увидеть перевод на своём языке. Отслеживайте прогресс и учитесь с интерактивными карточками.",
      vocab_hint_show: "Нажмите, чтобы показать перевод",
      vocab_hint_hide: "Нажмите, чтобы скрыть перевод",
      vocab_prev: "Предыдущее слово",
      vocab_next: "Следующее слово",
      vocab_progress: "Слово",
      faq_title: "Часто задаваемые вопросы",
      faq_q1: "Подходит ли Gwenchana для новичков?",
      faq_a1: "Да, вы можете начать с простых слов и пошаговой практики.",
      download_title: "Скачать Gwenchana",
      download_subtitle: "Начните бесплатный пробный период уже сегодня.",
      
    },
    ko: {
      nav_features: "기능",
      nav_faq: "자주 묻는 질문",
      nav_download: "다운로드",
      nav_about: "소개",
      nav_menu: "메뉴",
      hero_heading: "Gwenchana",
      hero_tagline: "그저 그런 한국어 학습 앱이 아니에요",
      hero_support: "AI 튜터가 이해를 돕고 매일 학습하도록 동기부여해요",
      btn_appstore_pretitle: "App Store에서",
      btn_appstore: "앱스토어",
      btn_googleplay_pretitle: "Google Play에서",
      btn_googleplay: "구글 플레이",
      features_title: "왜 Gwenchana?",
      features_multi_title: "다국어 지원",
      features_multi_desc: "여러 언어로 현지화된 인터페이스를 제공합니다.",
      features_auth_title: "안전한 로그인",
      features_auth_desc: "이메일, Google, Facebook으로 간편하게 로그인하세요.",
      features_vocab_title: "어휘 트레이닝",
      features_vocab_desc: "상호작용 연습과 플래시카드로 새 단어를 탄탄히.",
      features_progress_title: "진행 상황 추적",
      features_progress_desc: "KIIP 단계별 성장을 시각적으로 확인하세요.",
      features_ai_title: "AI 튜터",
      features_ai_desc: "언제든지 개인화된 설명을 제공하는 AI 코치.",
      features_offline_title: "직접 만드는 단어 카드",
      features_offline_desc: "단어·번역·예문을 추가해 나만의 학습 세트를 만드세요.",
      vocab_pill: "인터랙티브 프리뷰",
      vocab_title: "어휘를 쌓아가요",
      vocab_body: "한국어 단어를 눌러 선택한 언어로 번역을 확인하세요. 진행 상황을 따라가며 인터랙티브 플래시카드로 즐겁게 학습하세요.",
      vocab_hint_show: "탭하여 번역 보기",
      vocab_hint_hide: "탭하여 번역 숨기기",
      vocab_prev: "이전 단어",
      vocab_next: "다음 단어",
      vocab_progress: "단어",
      faq_title: "FAQ",
      faq_q1: "초보자에게도 좋나요?",
      faq_a1: "네, 기본 단어와 가이드 연습부터 시작할 수 있습니다.",
      download_title: "Gwenchana 다운로드",
      download_subtitle: "오늘 무료 체험을 시작하세요.",
      
    }
  };
  
  // Metadata for UI: labels and flags
  const languageMeta = {
    en: { label: 'EN', name: 'English', flag: '🇺🇸' },
    ru: { label: 'RU', name: 'Русский', flag: '🇷🇺' },
    ko: { label: 'KO', name: '한국어', flag: '🇰🇷' },
  };

  let activeLang = 'en';

  const vocabDeck = [
    { word: '안녕하세요', translations: { en: 'Hello', ru: 'Привет', ko: 'Hello' } },
    { word: '감사합니다', translations: { en: 'Thank you', ru: 'Спасибо', ko: 'Thank you' } },
    { word: '사랑', translations: { en: 'Love', ru: 'Любовь', ko: 'Love' } },
    { word: '학교', translations: { en: 'School', ru: 'Школа', ko: 'School' } },
    { word: '음식', translations: { en: 'Food', ru: 'Еда', ko: 'Food' } },
    { word: '가족', translations: { en: 'Family', ru: 'Семья', ko: 'Family' } },
    { word: '책', translations: { en: 'Book', ru: 'Книга', ko: 'Book' } }
  ];

  const vocabState = { index: 0, revealed: false };
  const vocabEls = {};

  function getCopy(key, lang = activeLang) {
    return translations[lang]?.[key] ?? translations.en?.[key] ?? '';
  }

  function renderVocabCard() {
    if (!vocabEls.card) return;
    const entry = vocabDeck[vocabState.index];
    const lang = activeLang;
    const translated = entry.translations[lang] ?? entry.translations.en;

    if (vocabEls.word) {
      vocabEls.word.textContent = entry.word;
    }
    if (vocabEls.translation) {
      vocabEls.translation.textContent = translated;
      const displayLang = lang === 'ru' ? 'ru' : 'en';
      vocabEls.translation.setAttribute('lang', displayLang);
    }
    vocabEls.card.classList.toggle('is-flipped', vocabState.revealed);
    vocabEls.card.setAttribute('aria-pressed', vocabState.revealed ? 'true' : 'false');
    if (vocabEls.hint) {
      vocabEls.hint.textContent = getCopy(vocabState.revealed ? 'vocab_hint_hide' : 'vocab_hint_show');
    }
    if (vocabEls.current) {
      vocabEls.current.textContent = String(vocabState.index + 1);
    }
    if (vocabEls.total) {
      vocabEls.total.textContent = String(vocabDeck.length);
    }
    updateVocabControls();
  }

  function launchConfetti() {
    if (!vocabEls.confetti) return;
    const colors = ['#6366f1', '#22d3ee', '#fb7185', '#facc15', '#34d399'];
    const pieceCount = 24;
    for (let i = 0; i < pieceCount; i += 1) {
      const piece = document.createElement('span');
      piece.className = 'confetti-piece';
      piece.style.left = `${Math.random() * 100}%`;
      piece.style.setProperty('--cx', `${Math.random() * 180 - 90}px`);
      piece.style.backgroundColor = colors[i % colors.length];
      piece.style.animationDelay = `${Math.random() * 0.35}s`;
      vocabEls.confetti.appendChild(piece);
      setTimeout(() => piece.remove(), 1700);
    }
    spawnFireworks(colors);
  }

  function spawnFireworks(colors) {
    if (!vocabEls.confetti) return;
    const bursts = 4;
    for (let i = 0; i < bursts; i += 1) {
      const firework = document.createElement('span');
      firework.className = 'firework';
      firework.style.left = `${15 + Math.random() * 70}%`;
      firework.style.top = `${20 + Math.random() * 40}%`;
      firework.style.setProperty('--fire-color', colors[(i * 2) % colors.length]);
      firework.style.animationDelay = `${i * 0.1}s`;
      vocabEls.confetti.appendChild(firework);
      setTimeout(() => firework.remove(), 1500);
    }
  }

  function updateVocabControls() {
    if (vocabEls.prev) {
      vocabEls.prev.disabled = vocabState.index === 0;
    }
    if (vocabEls.next && !vocabEls.next.dataset.locked) {
      vocabEls.next.disabled = false;
    }
  }

  function cycleVocab(direction) {
    if (!vocabDeck.length || !direction) return;
    const lastIndex = vocabDeck.length - 1;

    if (direction > 0) {
      if (vocabState.index === lastIndex) {
        if (vocabEls.next) {
          vocabEls.next.disabled = true;
          vocabEls.next.dataset.locked = 'true';
        }
        launchConfetti();
        updateVocabControls();
        setTimeout(() => {
          if (vocabEls.next) {
            vocabEls.next.disabled = false;
            delete vocabEls.next.dataset.locked;
          }
          vocabState.index = 0;
          vocabState.revealed = false;
          renderVocabCard();
        }, 1200);
        return;
      }
      vocabState.index += 1;
    } else if (direction < 0) {
      if (vocabState.index === 0) {
        return;
      }
      vocabState.index -= 1;
      if (vocabEls.next) {
        vocabEls.next.disabled = false;
        delete vocabEls.next.dataset.locked;
      }
    }

    vocabState.revealed = false;
    renderVocabCard();
  }

  function toggleVocabCard() {
    vocabState.revealed = !vocabState.revealed;
    renderVocabCard();
  }

  function initVocabDemo() {
    const card = document.querySelector('.vocab-card');
    if (!card) return;

    vocabEls.card = card;
    vocabEls.word = card.querySelector('.vocab-word');
    vocabEls.translation = card.querySelector('.vocab-translation');
    vocabEls.hint = document.querySelector('.vocab-hint');
    vocabEls.prev = document.querySelector('.vocab-nav--prev');
    vocabEls.next = document.querySelector('.vocab-nav--next');
    vocabEls.current = document.querySelector('.vocab-progress__current');
    vocabEls.total = document.querySelector('.vocab-progress__total');
    vocabEls.confetti = document.querySelector('.confetti-layer');

    if (vocabEls.total) vocabEls.total.textContent = String(vocabDeck.length);

    card.addEventListener('click', toggleVocabCard);

    vocabEls.prev?.addEventListener('click', () => cycleVocab(-1));
    vocabEls.next?.addEventListener('click', () => cycleVocab(1));

    const handleKey = (event) => {
      if (event.key === 'ArrowRight') {
        event.preventDefault();
        cycleVocab(1);
      } else if (event.key === 'ArrowLeft') {
        event.preventDefault();
        cycleVocab(-1);
      } else if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleVocabCard();
      }
    };

    card.addEventListener('keydown', handleKey);

    renderVocabCard();
  }

  function updateLangToggleUI(lang) {
    const meta = languageMeta[lang] || languageMeta.en;
    const toggle = document.getElementById('langToggle');
    if (!toggle) return;
    const flagEl = toggle.querySelector('.flag');
    const labelEl = toggle.querySelector('.label');
    if (flagEl) flagEl.textContent = meta.flag;
    if (labelEl) labelEl.textContent = meta.label;

    // Update options selected state
    document.querySelectorAll('.lang-option').forEach(btn => {
      const isSelected = btn.getAttribute('data-lang') === lang;
      const li = btn.closest('li');
      if (li) li.setAttribute('aria-selected', String(isSelected));
      btn.setAttribute('aria-selected', String(isSelected));
    });
  }

  function setLanguage(lang) {
    activeLang = lang;
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      const value = translations[lang]?.[key] ?? translations.en?.[key];
      if (typeof value === 'string') {
        el.textContent = value;
      }
    });
    localStorage.setItem("lang", lang); // save choice
    // reflect in UI
    updateLangToggleUI(lang);
    // update html lang attribute
    document.documentElement.setAttribute('lang', lang);
    renderVocabCard();
  }
  
  // On load: initialize language and dropdown behavior
  document.addEventListener("DOMContentLoaded", () => {
    const savedLang = localStorage.getItem("lang") || "en";
    setLanguage(savedLang);
    initVocabDemo();

    const dropdown = document.getElementById('langDropdown');
    const toggle = document.getElementById('langToggle');
    const menu = document.getElementById('langMenu');
    const header = document.getElementById('appBar');
    const primaryNav = document.getElementById('primaryNav');
    const menuToggle = document.getElementById('menuToggle');
    const navLinks = document.getElementById('navLinks');

    if (toggle && dropdown && menu) {
      const openMenu = () => {
        dropdown.classList.add('open');
        toggle.setAttribute('aria-expanded', 'true');
        // focus first selected or first item
        const selected = menu.querySelector('.lang-option[aria-selected="true"]');
        (selected || menu.querySelector('.lang-option'))?.focus?.();
      };
      const closeMenu = () => {
        dropdown.classList.remove('open');
        toggle.setAttribute('aria-expanded', 'false');
      };

      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains('open');
        if (isOpen) closeMenu(); else openMenu();
      });

      // Option click
      menu.querySelectorAll('.lang-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const lang = btn.getAttribute('data-lang');
          if (lang) setLanguage(lang);
          closeMenu();
        });
      });

      // Click outside closes
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          closeMenu();
        }
      });

      // Keyboard interactions
      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openMenu();
        }
      });
      menu.addEventListener('keydown', (e) => {
        const options = Array.from(menu.querySelectorAll('.lang-option'));
        const idx = options.indexOf(document.activeElement);
        if (e.key === 'Escape') { closeMenu(); toggle.focus(); }
        else if (e.key === 'ArrowDown') {
          e.preventDefault();
          const next = options[Math.min(options.length - 1, idx + 1)] || options[0];
          next.focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = options[Math.max(0, idx - 1)] || options[options.length - 1];
          prev.focus();
        } else if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const activeBtn = document.activeElement;
          if (activeBtn && activeBtn.classList.contains('lang-option')) {
            const lang = activeBtn.getAttribute('data-lang');
            if (lang) setLanguage(lang);
            closeMenu();
            toggle.focus();
          }
        }
      });
    }

    if (header) {
      const updateHeaderState = () => {
        const shouldElevate = window.scrollY > 12;
        header.classList.toggle('is-scrolled', shouldElevate);
      };

      updateHeaderState();
      window.addEventListener('scroll', updateHeaderState, { passive: true });
    }

    if (primaryNav && menuToggle && navLinks) {
      const openNavMenu = () => {
        navLinks.classList.add('is-open');
        menuToggle.classList.add('is-open');
        menuToggle.setAttribute('aria-expanded', 'true');
      };

      const closeNavMenu = () => {
        navLinks.classList.remove('is-open');
        menuToggle.classList.remove('is-open');
        menuToggle.setAttribute('aria-expanded', 'false');
      };

      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menuToggle.getAttribute('aria-expanded') === 'true';
        if (isOpen) closeNavMenu(); else openNavMenu();
      });

      navLinks.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => closeNavMenu());
      });

      document.addEventListener('click', (event) => {
        if (!primaryNav.contains(event.target)) {
          closeNavMenu();
        }
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          closeNavMenu();
        }
      });

      primaryNav.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeNavMenu();
          menuToggle.focus();
        }
      });
    }
  });
  
